const apiHost=window.location.hostname,apiPort=window.location.port,host=`http://${apiHost}:${apiPort}/api/console/v1/`,pageHost=`http://${apiHost}:${apiPort}/`;var menuPricesTable;$(document).ready((function(){getProfile(),getQueryParamValue("filter[trashed]")&&$("#filterTrashed").val(getQueryParamValue("filter[trashed]")),getMenuCategoryDropdown("menuCategoryId"),getMenuCategoryDropdown("menuCategoryIdEdit")}));var Toast=Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3});const Swal2=Swal.mixin({customClass:{input:"form-control"}});function getProfile(){var e={Authorization:"Bearer "+localStorage.getItem("bearer")};$.ajax({url:host+"profile",type:"GET",dataType:"json",headers:e,success:function(e){"admin"===e.user.user_role.id&&$("#addMenuBtn").show(),"admin"===e.user.user_role.id&&$("#delete").show(),$("#profileName").html(e.user.name),$("#profileRole").html(e.user.user_role.name)},error:function(e,t,a){console.error(JSON.parse(e.responseText).message),window.location.href=pageHost+"login?from-path="+encodeURIComponent(window.location.pathname)}})}function getMenuCategoryDropdown(e){var t={Authorization:"Bearer "+localStorage.getItem("bearer")};$.ajax({url:host+"dropdown/menu-category",type:"GET",headers:t,success:function(t){var a=$("#"+e);a.empty(),a.append('<option value="" style="display: none;" disabled selected>Pilih kategori menu</option>'),t.data.forEach((function(e,t){a.append('<option value="'+e.uuid+'">'+e.name+"</option>")}))},error:function(e,t,a){console.error(JSON.parse(e.responseText).message)}})}function getInventoryDropdown(e){var t={Authorization:"Bearer "+localStorage.getItem("bearer")};$.ajax({url:host+"dropdown/inventory"+(e?`?${e}`:""),type:"GET",headers:t,body:body,success:function(e){var t=$("#inventories");t.empty(),t.append('<option value="" style="display: none;" disabled selected>Pilih bahan yang dibutuhkan</option>'),e.data.forEach((function(e,a){t.append(`<option value="${e.uuid}" data-name="${e.name}" data-unit="${e.unit}">${e.name}</option>`)}))},error:function(e,t,a){console.error(JSON.parse(e.responseText).message)}})}function addMenu(e){event.preventDefault();var t={Authorization:"Bearer "+localStorage.getItem("bearer")};$.ajax({url:host+"menu",type:"POST",data:new FormData(e),contentType:!1,processData:!1,headers:t,success:function(t){clearInputErrors(),$("#primary").modal("hide"),clearForm(e.id),Toast.fire({icon:"success",title:"Data berhasil ditambahkan",timer:1500}),customized_datatable.ajax.reload()},error:function(e,t,a){clearInputErrors(),e.responseJSON&&$.each(e.responseJSON.errors,(function(e,t){var a=$('[name="'+e+'"]');a.addClass("is-invalid"),a.after('<div class="invalid-feedback">'+t+"</div>")})),console.error(JSON.parse(e.responseText).message)}})}let trashedFilter=getQueryParamValue("filter[trashed]")?getQueryParamValue("filter[trashed]"):"";$("#filterTrashed").on("change",(function(){trashedFilter=$(this).val(),addOrUpdateQueryParam("filter[trashed]",trashedFilter),customized_datatable.ajax.reload()}));let customized_datatable=$("#menuTable").DataTable({columns:[{data:null,render:function(e,t,a,n){return n.row+n.settings._iDisplayStart+1}},{data:null,render:function(e,t,a){return`<img src="${pageHost}${a.image}" class="me-2" style="width: 100px; height: 100px; object-fit: cover;"></img>`+a.name}},{data:"category"},{data:null,render:function(e,t,a){return a.price_display}},{data:null,render:function(e,t,a){return dateIndFormat(a.updated_at)}},{data:null,width:"28%",render:function(e,t,a){let n='<button onclick="getMenu(this)" data-uuid="'+a.uuid+'" class="btn btn-secondary d-flex justify-content-center align-items-center"> <span class="me-2"><i class="bi bi-pencil-square"></i></i></span>Ubah</button>',r='<button onclick="getPrices(this)" data-uuid="'+a.uuid+'" class="btn btn-success d-flex justify-content-center align-items-center"> <span class="me-2"><i class="bi bi-cash-coin"></i></i></i></span>Daftar Harga & Bahan</button>',i='<button onclick="restoreMenu(this)" data-uuid="'+a.uuid+'" class="btn btn-danger d-flex justify-content-center align-items-center"> <span class="me-2"><i class="bi bi-unlock"></i></i></span>Restore</button>';return'<div class="d-flex gap-2">'+("admin"===metaValue.logined_role?"active"===a.status?n+r:i:"")+"</div>"}}],ajax:{url:host+"menu",headers:{Authorization:"Bearer "+localStorage.getItem("bearer")},data:function(e){return{q:e.search.value,filter:{trashed:trashedFilter},page:e.start/e.length+1,limit:e.length}},dataFilter:function(e){var t=jQuery.parseJSON(e);return t.recordsTotal=t.meta.total,t.recordsFiltered=t.meta.total,metaValue=t.meta,t.data=t.data,JSON.stringify(t)},error:function(e,t,a){console.error("Error fetching data:",a)},cache:!0},paging:!0,pageLength:10,lengthMenu:[5,10,25,50,100],responsive:!0,autoWidth:!1,lengthChange:!0,ordering:!1,processing:!0,serverSide:!0,language:dataTablesIdLang});function getMenu(e){var t={Authorization:"Bearer "+localStorage.getItem("bearer")};$.ajax({url:host+"menu/"+e.dataset.uuid,type:"GET",data:{},headers:t,success:function(e){$("#uuidEdit").val(e.data.uuid),$("#nameEdit").val(e.data.name),$("#menuCategoryIdEdit").val(e.data.category_uuid),$("#delete").attr("data-uuid",e.data.uuid),$("#secondaryEdit").modal("show")},error:function(e,t,a){console.error(JSON.parse(e.responseText).message)}})}function getPrices(e){$.fn.DataTable.isDataTable("#menuPricesTable")&&$("#menuPricesTable").DataTable().clear().destroy();var t={Authorization:"Bearer "+localStorage.getItem("bearer")};$.ajax({url:host+"menu/"+e.dataset.uuid+"/price",type:"GET",data:{},headers:t,success:function(t){document.getElementById("tempRecipeForm").setAttribute("data-uuid",e.dataset.uuid),$("#modalMenuName").html(t.meta.menu_name),menuPricesTable=$("#menuPricesTable").DataTable({columns:[{data:null,render:function(e,t,a,n){return n.row+n.settings._iDisplayStart+1}},{data:null,width:"95%",render:function(e,t,a,n){let r=a.recipes.map((e=>`<button type="button" class="list-group-item list-group-item-action d-flex justify-content-between"><span>${e.name}</span><span class="fw-semibold">${e.qty}${e.unit} @${e.per_serving_price}</span></button>`)).join(""),i="active"!==a.status?`<button class="btn btn-success w-100 mb-2 btn-sm" data-menu-uuid="${metaValue.menu_uuid}" data-uuid="${a.uuid}" onclick="activatePrice(this)">Aktifkan harga</button>`:"",o="active"===a.status?"success":"danger";return`<div class="accordion-item">\n\t\t\t\t\t\t\t\t<h2 class="accordion-header" id="headingOne${n.row+n.settings._iDisplayStart+1}">\n\t\t\t\t\t\t\t\t\t<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${n.row+n.settings._iDisplayStart+1}" aria-expanded="false">\n\t\t\t\t\t\t\t\t\t<span class="me-2 fw-bold">${a.price}</span><span class="badge bg-light-${o}">${a.status}</span>\n\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t\t\t<div id="collapse${n.row+n.settings._iDisplayStart+1}" class="accordion-collapse collapse" style="">\n\t\t\t\t\t\t\t\t\t<div class="accordion-body">\n                                        ${i}\n                                        <div class="list-group">\n                                            ${r}\n                                        <hr>\n                                        <button type="button" class="list-group-item list-group-item-action d-flex justify-content-end"><span class="fw-semibold">HPP: ${a.total_per_serving_price}</span></button>\n                                        </div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>`}}],ajax:{url:host+"menu/"+e.dataset.uuid+"/price",headers:{Authorization:"Bearer "+localStorage.getItem("bearer")},data:function(e){return{q:e.search.value,filter:{},page:e.start/e.length+1,limit:e.length}},dataFilter:function(e){var t=jQuery.parseJSON(e);return t.recordsTotal=t.meta.total,t.recordsFiltered=t.meta.total,$("#successPrices").modal("show"),metaValue=t.meta,t.data=t.data,JSON.stringify(t)},error:function(e,t,a){console.error("Error fetching data:",a)},cache:!0},paging:!0,pageLength:5,lengthMenu:[5,10,25,50,100],responsive:!0,autoWidth:!1,lengthChange:!0,ordering:!1,processing:!0,serverSide:!0,language:dataTablesIdLang})},error:function(e,t,a){console.error(JSON.parse(e.responseText).message)}})}function getInventoryHistoryDropdown(e){var t={Authorization:"Bearer "+localStorage.getItem("bearer")};$.ajax({url:host+"dropdown/inventory/"+e+"/history",type:"GET",data:{},headers:t,success:function(t){var a=$(`#${e}`);a.empty(),a.append('<option value="" style="display: none;" disabled selected>Pilih harga restock terbaru</option>'),t.data.forEach((function(e,t){a.append(`<option value="${e.uuid}" data-price-per-unit="${e.price_per_unit}">${e.price} @${e.qty}</option>`)}))},error:function(e,t,a){console.error(JSON.parse(e.responseText).message)}})}const rupiah=e=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR"}).format(e);function calculateHpp(){let e=0;0!==$('[name="inventory_history[]"]').length?($('[name="inventory_history[]"]').each((function(){var t=$(this).find("option:selected"),a=t.data("price-per-unit")?t.data("price-per-unit"):0,n=$(this).closest("tr"),r=parseFloat(n.find('input[name="qty[]"]').val());e+=a*r})),$("#hppPlaceholder").html(`HPP: ${rupiah(e)}`)):$("#hppPlaceholder").html(`HPP: ${rupiah(e)}`)}function changeUnitPlaceholder(e){var t=$("#"+e.id).find(":selected");$("#unitPlaceholder").html(t.data("unit"))}function addPrice(e){$("#successPrices").modal("hide"),$("#addMenuPriceTable tbody").empty(),$("#saveMenuPriceButton").hide(),getInventoryDropdown(),calculateHpp(),$("#successAddMenuPrice").modal("show")}function backToPriceModal(){$("#successAddMenuPrice").modal("hide"),$("#successPrices").modal("show")}function addRecipeTemp(e){event.preventDefault();let t=$("#"+e.id).serializeArray();var a=$("#inventories").find(":selected"),n=a.data("name"),r=a.data("unit"),i=`<tr>\n                <td class="row-number">${$("#addMenuPriceTable tbody tr").length+1}</td>\n                <td>${n}</td>\n                <td>${t[1].value}${r}</td>\n                <td>\n                    <select id="${t[0].value}" data-group="${t[0].value}" onchange="calculateHpp()" name="inventory_history[]" class="form-control" required>\n                        <option style="display: none;" selected>Pilih harga restock terbaru</option>\n                    </select>\n                </td>\n                <input type="hidden" id="inventoryUuid" value="${t[0].value}" data-group="${t[0].value}" name="inventory_uuid[]">\n                <input type="hidden" id="qty" value="${t[1].value}" data-group="${t[0].value}" name="qty[]">\n                <td><button type="button" onclick="removeRow(this)" class="removeRow btn btn-danger w-100">Hapus</button></td>\n                </tr>`;getInventoryHistoryDropdown(t[0].value),clearForm(e.id),$("#unitPlaceholder").html(""),$("#addMenuPriceTable tbody").append(i),getInventoryDropdown(`excludes=${$("#tempRecipeForm").serializeArray("inventory_uuid").filter((e=>"inventory_uuid[]"===e.name)).map((e=>e.value))}`),$("#saveMenuPriceButton").show()}function saveMenuPriceForm(e){event.preventDefault();let t={};$("[data-group]").each((function(){let e=$(this).data("group");t[e]=!0}));let a=Object.keys(t),n={};a.forEach((function(e,t){n[t]=[],$('[data-group="'+e+'"]').each((function(){let a=$(this).attr("name"),r=$(this).val();n[t].push({name:a,value:r,group:e})}))}));let r=[],i=$(`#${e.id}`).find('input[name="price"]').val();Object.keys(n).forEach((e=>{let t=n[e].find((e=>"inventory_history[]"===e.name)),a=n[e].find((e=>"qty[]"===e.name));if(t&&a){let e={uuid:t.value,qty:a.value};e=Object.fromEntries(Object.entries(e).filter((([e,t])=>null!=t))),r.push(e)}}));let o={recipes:r};i&&(o.price=i);var s={Authorization:"Bearer "+localStorage.getItem("bearer")};$.ajax({url:host+`menu/${e.dataset.uuid}/price`,type:"POST",data:o,headers:s,success:function(e){clearInputErrors(),Toast.fire({icon:"success",title:"Harga menu berhasil ditambahkan",timer:1500}),menuPricesTable.ajax.reload(),backToPriceModal()},error:function(e,t,a){clearInputErrors(),e.responseJSON&&$.each(e.responseJSON.errors,(function(e,t){if("price"===e){var a=$('[name="'+e+'"]');a.addClass("is-invalid"),a.after('<div class="invalid-feedback">'+t+"</div>")}if(e.includes("recipes")&&e.includes("uuid")){let t=parseInt(e.split(".")[1]);$('[name="inventory_history[]"]').each((function(e,a){if(e===t){let e=$(a);e.addClass("is-invalid"),e.after('<div class="invalid-feedback">Pilihan tidak boleh kosong</div>')}}))}})),console.error(JSON.parse(e.responseText).message)}})}function updateRowNumbers(){$("#addMenuPriceTable tbody tr").each((function(e){$(this).find(".row-number").text(e+1)}))}function removeRow(e){$(e).closest("tr").remove(),updateRowNumbers(),calculateHpp(),getInventoryDropdown(`excludes=${$("#tempRecipeForm").serializeArray("inventory_uuid").filter((e=>"inventory_uuid[]"===e.name)).map((e=>e.value))}`)}function editMenu(e){event.preventDefault();var t={Authorization:"Bearer "+localStorage.getItem("bearer")},a=new FormData(e);a.append("_method","PUT"),$.ajax({url:host+"menu/"+$("#"+e.id).serializeArray()[0].value,type:"POST",data:a,contentType:!1,processData:!1,headers:t,success:function(t){$("#secondaryEdit").modal("hide"),clearInputErrors(),clearForm(e.id),Toast.fire({icon:"success",title:"Data berhasil diubah",timer:1500});let a=customized_datatable.page();customized_datatable.ajax.reload((function(){customized_datatable.page(a).draw(!1)}))},error:function(e,t,a){clearInputErrors(),e.responseJSON&&$.each(e.responseJSON.errors,(function(e,t){var a=$('[name="'+e+'"]');a.addClass("is-invalid"),a.after('<div class="invalid-feedback">'+t+"</div>")})),console.error(JSON.parse(e.responseText).message)}})}function deleteMenu(e){Swal2.fire({icon:"question",title:"Apakah anda yakin?",text:"Apakah anda yakin menghapus menu ini?",showCancelButton:!0,confirmButtonText:"Ya",cancelButtonText:"Tidak",reverseButtons:!1}).then((t=>{if(t.isConfirmed){var a={Authorization:"Bearer "+localStorage.getItem("bearer")};$.ajax({url:host+"menu/"+e.dataset.uuid,type:"DELETE",headers:a,success:function(e){$("#secondaryEdit").modal("hide"),clearInputErrors(),clearForm("editMenuForm"),Toast.fire({icon:"success",title:"Menu berhasil terhapus",timer:1500}),customized_datatable.ajax.reload()},error:function(e,t,a){Toast.fire({icon:"error",title:JSON.parse(e.responseText).message,timer:1500}),console.error(JSON.parse(e.responseText).message)}})}else t.dismiss===Swal.DismissReason.cancel&&console.log("Operation cancelled")}))}function restoreMenu(e){Swal2.fire({icon:"question",title:"Apakah anda yakin?",text:"Apakah anda yakin mengembalikan menu ini?",showCancelButton:!0,confirmButtonText:"Ya",cancelButtonText:"Tidak",reverseButtons:!1}).then((t=>{if(t.isConfirmed){var a={Authorization:"Bearer "+localStorage.getItem("bearer")};$.ajax({url:host+"menu/"+e.dataset.uuid+"/restore",type:"GET",headers:a,success:function(e){Toast.fire({icon:"success",title:"Menu berhasil dikembalikan",timer:1500}),customized_datatable.ajax.reload()},error:function(e,t,a){console.error(JSON.parse(e.responseText).message)}})}else t.dismiss===Swal.DismissReason.cancel&&console.log("Operation cancelled")}))}function activatePrice(e){Swal2.fire({icon:"question",title:"Apakah anda yakin?",text:"Apakah anda yakin mengaktifkan harga ini?",showCancelButton:!0,confirmButtonText:"Ya",cancelButtonText:"Tidak",reverseButtons:!1}).then((t=>{if(t.isConfirmed){var a={Authorization:"Bearer "+localStorage.getItem("bearer")};$.ajax({url:host+"menu/"+e.dataset.menuUuid+"/price/"+e.dataset.uuid+"/activate",type:"GET",headers:a,success:function(e){Toast.fire({icon:"success",title:"Harga berhasil diaktifkan",timer:1500});let t=menuPricesTable.page();menuPricesTable.ajax.reload((function(){menuPricesTable.page(t).draw(!1)})),t=customized_datatable.page(),customized_datatable.ajax.reload((function(){customized_datatable.page(t).draw(!1)}))},error:function(e,t,a){console.error(JSON.parse(e.responseText).message)}})}else t.dismiss===Swal.DismissReason.cancel&&console.log("Operation cancelled")}))}const setTableColor=()=>{document.querySelectorAll(".dataTables_paginate .pagination").forEach((e=>{e.classList.add("pagination-primary")}))};document.querySelectorAll(".dataTables_paginate .pagination").forEach((e=>{e.classList.add("pagination-primary")}));
