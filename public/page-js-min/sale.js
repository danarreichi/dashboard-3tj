const apiHost=window.location.hostname,apiPort=window.location.port,host=`http://${apiHost}:${apiPort}/api/console/v1/`,pageHost=`http://${apiHost}:${apiPort}/`;var menuPricesTable;let startBetween=null;function getTodayDate(){const e=new Date,a=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${a}-${t}-${r},${a}-${t}-${r}`}$(document).ready((function(){getProfile(),getQueryParamValue("filter[trashed]")&&$("#filterTrashed").val(getQueryParamValue("filter[trashed]"))}));var flatPickr=flatpickr(".flatpickr-range",{altInput:!0,altFormat:"F j, Y",dateFormat:"Y-m-d",mode:"range",locale:"id"}),Toast=Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3});const Swal2=Swal.mixin({customClass:{input:"form-control"}});function getDatepickr(e){let a=e._flatpickr.selectedDates;2===a.length&&(startBetween=`${a[0].toLocaleDateString("sv-SE")},${a[1].toLocaleDateString("sv-SE")}`,customized_datatable.ajax.reload())}function getProfile(){var e={Authorization:"Bearer "+localStorage.getItem("bearer")};$.ajax({url:host+"profile",type:"GET",dataType:"json",headers:e,success:function(e){"admin"===e.user.user_role.id&&$("#addMenuBtn").show(),"admin"===e.user.user_role.id&&$("#delete").show(),$("#profileName").html(e.user.name),$("#profileRole").html(e.user.user_role.name)},error:function(e,a,t){console.error(JSON.parse(e.responseText).message),window.location.href=pageHost+"login?from-path="+encodeURIComponent(window.location.pathname)}})}function getMenuCategoryDropdown(e){var a={Authorization:"Bearer "+localStorage.getItem("bearer")};$.ajax({url:host+"dropdown/menu-category",type:"GET",headers:a,success:function(a){var t=$("#"+e);t.empty(),t.append('<option value="" style="display: none;" disabled selected>Pilih kategori menu</option>'),a.data.forEach((function(e,a){t.append('<option value="'+e.uuid+'">'+e.name+"</option>")}))},error:function(e,a,t){console.error(JSON.parse(e.responseText).message)}})}function getInventoryDropdown(e){var a={Authorization:"Bearer "+localStorage.getItem("bearer")};$.ajax({url:host+"dropdown/inventory"+(e?`?${e}`:""),type:"GET",headers:a,body:body,success:function(e){var a=$("#inventories");a.empty(),a.append('<option value="" style="display: none;" disabled selected>Pilih bahan yang dibutuhkan</option>'),e.data.forEach((function(e,t){a.append(`<option value="${e.uuid}" data-name="${e.name}" data-unit="${e.unit}">${e.name}</option>`)}))},error:function(e,a,t){console.error(JSON.parse(e.responseText).message)}})}function addMenu(e){event.preventDefault();var a={Authorization:"Bearer "+localStorage.getItem("bearer")};$.ajax({url:host+"menu",type:"POST",data:new FormData(e),contentType:!1,processData:!1,headers:a,success:function(a){clearInputErrors(),$("#primary").modal("hide"),clearForm(e.id),Toast.fire({icon:"success",title:"Data berhasil ditambahkan",timer:1500}),customized_datatable.ajax.reload()},error:function(e,a,t){clearInputErrors(),e.responseJSON&&$.each(e.responseJSON.errors,(function(e,a){var t=$('[name="'+e+'"]');t.addClass("is-invalid"),t.after('<div class="invalid-feedback">'+a+"</div>")})),console.error(JSON.parse(e.responseText).message)}})}let trashedFilter=getQueryParamValue("filter[trashed]")?getQueryParamValue("filter[trashed]"):"";$("#filterTrashed").on("change",(function(){trashedFilter=$(this).val(),addOrUpdateQueryParam("filter[trashed]",trashedFilter),customized_datatable.ajax.reload()}));let customized_datatable=$("#menuTable").DataTable({columns:[{data:null,render:function(e,a,t,r){return r.row+r.settings._iDisplayStart+1}},{data:null,render:function(e,a,t){return`<img src="${pageHost}${t.image}" class="me-2" style="width: 100px; height: 100px; object-fit: cover;"></img>`+t.name}},{data:"category"},{data:null,render:function(e,a,t){return t.sales_count+" terjual"}},{data:null,render:function(e,a,t){return t.sales_sum}},{data:null,width:"28%",render:function(e,a,t){return`<button onclick="getSale(this)" data-uuid="${t.uuid}" class="btn btn-success d-flex justify-content-center align-items-center">\n                            <span class="me-2">\n                                <i class="bi bi-clock-history"></i></i>\n                            </span>Penjualan\n                            </button>`}}],ajax:{url:host+"sale",headers:{Authorization:"Bearer "+localStorage.getItem("bearer")},data:function(e){return{q:e.search.value,filter:{trashed:trashedFilter},start_between:startBetween||getTodayDate(),page:e.start/e.length+1,limit:e.length}},dataFilter:function(e){var a=jQuery.parseJSON(e);if(a.recordsTotal=a.meta.total,a.recordsFiltered=a.meta.total,a.meta.start_date&&a.meta.end_date){let e=a.meta.start_date.split(" ")[0],t=a.meta.end_date.split(" ")[0];flatPickr.set("minDate",e),flatPickr.set("maxDate",t)}return a.meta.earnings&&a.meta.earningsAfterDiscount&&a.meta.usedDiscounts&&($("#earnings").html(a.meta.earnings),$("#usedDiscounts").html(a.meta.usedDiscounts),$("#earningsAfterDiscount").html(a.meta.earningsAfterDiscount)),metaValue=a.meta,a.data=a.data,JSON.stringify(a)},error:function(e,a,t){console.error("Error fetching data:",t)},cache:!0},paging:!0,pageLength:10,lengthMenu:[5,10,25,50,100],responsive:!0,autoWidth:!1,lengthChange:!0,ordering:!1,processing:!0,serverSide:!0,language:dataTablesIdLang});function getSale(e){$.fn.DataTable.isDataTable("#saleHistoryTable")&&$("#saleHistoryTable").DataTable().clear().destroy();localStorage.getItem("bearer");menuPricesTable=$("#saleHistoryTable").DataTable({columns:[{data:null,render:function(e,a,t,r){return r.row+r.settings._iDisplayStart+1}},{data:null,render:function(e,a,t){return t.qty+" terjual"}},{data:"price_per_unit"},{data:"sales_sum"},{data:null,render:function(e,a,t){return dateIndWithTimeFormat(t.updated_at)}}],ajax:{url:host+"menu/"+e.dataset.uuid+"/sale",headers:{Authorization:"Bearer "+localStorage.getItem("bearer")},data:function(e){return{q:e.search.value,filter:{start_between:startBetween||getTodayDate()},page:e.start/e.length+1,limit:e.length}},dataFilter:function(e){var a=jQuery.parseJSON(e);return a.recordsTotal=a.meta.total,a.recordsFiltered=a.meta.total,$("#productName").html(a.meta.product_name),$("#productSalesQty").html(`${a.meta.count_sale} terjual`),$("#productSales").html(a.meta.total_sale),$("#infoHistory").modal("show"),metaValue=a.meta,a.data=a.data,JSON.stringify(a)},error:function(e,a,t){console.error("Error fetching data:",t)},cache:!0},paging:!0,pageLength:5,lengthMenu:[5,10,25,50,100],responsive:!0,autoWidth:!1,lengthChange:!0,ordering:!1,processing:!0,searching:!1,serverSide:!0,language:dataTablesIdLang})}function getInventoryHistoryDropdown(e){var a={Authorization:"Bearer "+localStorage.getItem("bearer")};$.ajax({url:host+"dropdown/inventory/"+e+"/history",type:"GET",data:{},headers:a,success:function(a){var t=$(`#${e}`);t.empty(),t.append('<option value="" style="display: none;" disabled selected>Pilih harga restock terbaru</option>'),a.data.forEach((function(e,a){t.append(`<option value="${e.uuid}" data-price-per-unit="${e.price_per_unit}">${e.price}</option>`)}))},error:function(e,a,t){console.error(JSON.parse(e.responseText).message)}})}const rupiah=e=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR"}).format(e);function calculateHpp(){let e=0;0!==$('[name="inventory_history[]"]').length?($('[name="inventory_history[]"]').each((function(){var a=$(this).find("option:selected"),t=a.data("price-per-unit")?a.data("price-per-unit"):0,r=$(this).closest("tr"),n=parseFloat(r.find('input[name="qty[]"]').val());e+=t*n})),$("#hppPlaceholder").html(`HPP: ${rupiah(e)}`)):$("#hppPlaceholder").html(`HPP: ${rupiah(e)}`)}function changeUnitPlaceholder(e){var a=$("#"+e.id).find(":selected");$("#unitPlaceholder").html(a.data("unit"))}function addPrice(e){$("#successPrices").modal("hide"),$("#addMenuPriceTable tbody").empty(),$("#saveMenuPriceButton").hide(),getInventoryDropdown(),calculateHpp(),$("#successAddMenuPrice").modal("show")}function backToPriceModal(){$("#successAddMenuPrice").modal("hide"),$("#successPrices").modal("show")}function addRecipeTemp(e){event.preventDefault();let a=$("#"+e.id).serializeArray();var t=$("#inventories").find(":selected"),r=t.data("name"),n=t.data("unit"),o=`<tr>\n                <td class="row-number">${$("#addMenuPriceTable tbody tr").length+1}</td>\n                <td>${r}</td>\n                <td>${a[1].value}${n}</td>\n                <td>\n                    <select id="${a[0].value}" data-group="${a[0].value}" onchange="calculateHpp()" name="inventory_history[]" class="form-control" required>\n                        <option style="display: none;" selected>Pilih harga restock terbaru</option>\n                    </select>\n                </td>\n                <input type="hidden" id="inventoryUuid" value="${a[0].value}" data-group="${a[0].value}" name="inventory_uuid[]">\n                <input type="hidden" id="qty" value="${a[1].value}" data-group="${a[0].value}" name="qty[]">\n                <td><button type="button" onclick="removeRow(this)" class="removeRow btn btn-danger w-100">Hapus</button></td>\n                </tr>`;getInventoryHistoryDropdown(a[0].value),clearForm(e.id),$("#unitPlaceholder").html(""),$("#addMenuPriceTable tbody").append(o),getInventoryDropdown(`excludes=${$("#tempRecipeForm").serializeArray("inventory_uuid").filter((e=>"inventory_uuid[]"===e.name)).map((e=>e.value))}`),$("#saveMenuPriceButton").show()}function saveMenuPriceForm(e){event.preventDefault();let a={};$("[data-group]").each((function(){let e=$(this).data("group");a[e]=!0}));let t=Object.keys(a),r={};t.forEach((function(e,a){r[a]=[],$('[data-group="'+e+'"]').each((function(){let t=$(this).attr("name"),n=$(this).val();r[a].push({name:t,value:n,group:e})}))}));let n=[],o=$(`#${e.id}`).find('input[name="price"]').val();Object.keys(r).forEach((e=>{let a=r[e].find((e=>"inventory_history[]"===e.name)),t=r[e].find((e=>"qty[]"===e.name));if(a&&t){let e={uuid:a.value,qty:t.value};e=Object.fromEntries(Object.entries(e).filter((([e,a])=>null!=a))),n.push(e)}}));let i={recipes:n};o&&(i.price=o);var s={Authorization:"Bearer "+localStorage.getItem("bearer")};$.ajax({url:host+`menu/${e.dataset.uuid}/price`,type:"POST",data:i,headers:s,success:function(e){clearInputErrors(),Toast.fire({icon:"success",title:"Harga menu berhasil ditambahkan",timer:1500}),menuPricesTable.ajax.reload(),backToPriceModal()},error:function(e,a,t){clearInputErrors(),e.responseJSON&&$.each(e.responseJSON.errors,(function(e,a){if("price"===e){var t=$('[name="'+e+'"]');t.addClass("is-invalid"),t.after('<div class="invalid-feedback">'+a+"</div>")}if(e.includes("recipes")&&e.includes("uuid")){let a=parseInt(e.split(".")[1]);$('[name="inventory_history[]"]').each((function(e,t){if(e===a){let e=$(t);e.addClass("is-invalid"),e.after('<div class="invalid-feedback">Pilihan tidak boleh kosong</div>')}}))}})),console.error(JSON.parse(e.responseText).message)}})}function updateRowNumbers(){$("#addMenuPriceTable tbody tr").each((function(e){$(this).find(".row-number").text(e+1)}))}function removeRow(e){$(e).closest("tr").remove(),updateRowNumbers(),calculateHpp(),getInventoryDropdown(`excludes=${$("#tempRecipeForm").serializeArray("inventory_uuid").filter((e=>"inventory_uuid[]"===e.name)).map((e=>e.value))}`)}function editMenu(e){event.preventDefault();var a={Authorization:"Bearer "+localStorage.getItem("bearer")},t=new FormData(e);t.append("_method","PUT"),$.ajax({url:host+"menu/"+$("#"+e.id).serializeArray()[0].value,type:"POST",data:t,contentType:!1,processData:!1,headers:a,success:function(a){$("#secondaryEdit").modal("hide"),clearInputErrors(),clearForm(e.id),Toast.fire({icon:"success",title:"Data berhasil diubah",timer:1500});let t=customized_datatable.page();customized_datatable.ajax.reload((function(){customized_datatable.page(t).draw(!1)}))},error:function(e,a,t){clearInputErrors(),e.responseJSON&&$.each(e.responseJSON.errors,(function(e,a){var t=$('[name="'+e+'"]');t.addClass("is-invalid"),t.after('<div class="invalid-feedback">'+a+"</div>")})),console.error(JSON.parse(e.responseText).message)}})}function deleteMenu(e){Swal2.fire({icon:"question",title:"Apakah anda yakin?",text:"Apakah anda yakin menghapus menu ini?",showCancelButton:!0,confirmButtonText:"Ya",cancelButtonText:"Tidak",reverseButtons:!1}).then((a=>{if(a.isConfirmed){var t={Authorization:"Bearer "+localStorage.getItem("bearer")};$.ajax({url:host+"menu/"+e.dataset.uuid,type:"DELETE",headers:t,success:function(e){$("#secondaryEdit").modal("hide"),clearInputErrors(),clearForm("editMenuForm"),Toast.fire({icon:"success",title:"Menu berhasil terhapus",timer:1500}),customized_datatable.ajax.reload()},error:function(e,a,t){Toast.fire({icon:"error",title:JSON.parse(e.responseText).message,timer:1500}),console.error(JSON.parse(e.responseText).message)}})}else a.dismiss===Swal.DismissReason.cancel&&console.log("Operation cancelled")}))}function restoreMenu(e){Swal2.fire({icon:"question",title:"Apakah anda yakin?",text:"Apakah anda yakin mengembalikan menu ini?",showCancelButton:!0,confirmButtonText:"Ya",cancelButtonText:"Tidak",reverseButtons:!1}).then((a=>{if(a.isConfirmed){var t={Authorization:"Bearer "+localStorage.getItem("bearer")};$.ajax({url:host+"menu/"+e.dataset.uuid+"/restore",type:"GET",headers:t,success:function(e){Toast.fire({icon:"success",title:"Menu berhasil dikembalikan",timer:1500}),customized_datatable.ajax.reload()},error:function(e,a,t){console.error(JSON.parse(e.responseText).message)}})}else a.dismiss===Swal.DismissReason.cancel&&console.log("Operation cancelled")}))}function activatePrice(e){Swal2.fire({icon:"question",title:"Apakah anda yakin?",text:"Apakah anda yakin mengaktifkan harga ini?",showCancelButton:!0,confirmButtonText:"Ya",cancelButtonText:"Tidak",reverseButtons:!1}).then((a=>{if(a.isConfirmed){var t={Authorization:"Bearer "+localStorage.getItem("bearer")};$.ajax({url:host+"menu/"+e.dataset.menuUuid+"/price/"+e.dataset.uuid+"/activate",type:"GET",headers:t,success:function(e){Toast.fire({icon:"success",title:"Harga berhasil diaktifkan",timer:1500});let a=menuPricesTable.page();menuPricesTable.ajax.reload((function(){menuPricesTable.page(a).draw(!1)})),a=customized_datatable.page(),customized_datatable.ajax.reload((function(){customized_datatable.page(a).draw(!1)}))},error:function(e,a,t){console.error(JSON.parse(e.responseText).message)}})}else a.dismiss===Swal.DismissReason.cancel&&console.log("Operation cancelled")}))}const setTableColor=()=>{document.querySelectorAll(".dataTables_paginate .pagination").forEach((e=>{e.classList.add("pagination-primary")}))};document.querySelectorAll(".dataTables_paginate .pagination").forEach((e=>{e.classList.add("pagination-primary")}));
