const apiHost=window.location.hostname,apiPort=window.location.port,host=`http://${apiHost}:${apiPort}/api/console/v1/`,pageHost=`http://${apiHost}:${apiPort}/`;var selectedCategory,selectedMenu=[],discountType="nominal";function getProfile(){var e={Authorization:"Bearer "+localStorage.getItem("bearer")};$.ajax({url:host+"profile",type:"GET",dataType:"json",headers:e,success:function(e){"admin"===e.user.user_role.id&&$("#addMenuCategoryBtn").show(),"admin"===e.user.user_role.id&&$("#delete").show(),$("#profileName").html(e.user.name),$("#profileRole").html(e.user.user_role.name)},error:function(e,t,a){console.error(JSON.parse(e.responseText).message),window.location.href=pageHost+"login?from-path="+encodeURIComponent(window.location.pathname)}})}$(document).ready((function(){getProfile(),getMenuCategory(),getMenuPrices(),scrollCategoryMenu()})),$("#formToggleButton").click((function(){$("#discountDiv, #paymentMethodDiv").toggle(),$("#discountDiv").is(":visible")?$(this).html("Metode pembayaran?"):$(this).html("Tambahkan diskon?")}));var Toast=Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3});const Swal2=Swal.mixin({customClass:{input:"form-control"}});function selectCategory(e){selectedCategory=e.dataset.uuid,$(".menu-category-card").each((function(){$(this).removeClass("menu-category-card-selected"),$(this).removeClass("clicked")})),$(e).hasClass("menu-category-card-selected")?($(e).removeClass("menu-category-card-selected"),$(e).toggleClass("clicked")):($(e).toggleClass("clicked"),$(e).addClass("menu-category-card-selected")),e.dataset.uuid||$("#search").removeAttr("data-category-uuid"),$("#search").attr("data-category-uuid",e.dataset.uuid),$(".accordion-item").hasClass("accordion-item")?refreshStock(e.dataset.uuid):getMenuPrices(e.dataset.uuid)}let loadMenu=!1;function selectMenu(e){if($(e).toggleClass("clicked"),$(e).hasClass("clicked"))selectedMenu.push(e.dataset.uuid),debouncedGetMenu(selectedMenu),selectedMenu.length>0&&$("#chartList").find("p.fs-5.text-center").remove();else{$("#chartList").find(`.accordion-item[data-uuid="${e.dataset.uuid}"]`).find('input[type="number"][name="qty[]"]').val(0);$(".accordion-item").hasClass("accordion-item")&&refreshStock(selectedCategory),$("#chartList").find(`.accordion-item[data-uuid="${e.dataset.uuid}"]`).remove(),selectedMenu=selectedMenu.filter((t=>t!==e.dataset.uuid)),debouncedGetMenu(selectedMenu)}}function checkoutConfirmation(){"cash"===$("#paymentMethods").find("button.active").data("method")?($("#customerMoney").val(null),$("#customerExchangeMoney").val(null),$("#primary").modal("show")):Swal2.fire({icon:"question",title:"Periksa pembayaran QRIS",text:"Apakah anda ingin menkonfirmasi transaksi ini?",showCancelButton:!0,confirmButtonText:"Ya",cancelButtonText:"Tidak",reverseButtons:!1}).then((e=>{e.isConfirmed?continueCheckout():e.dismiss===Swal.DismissReason.cancel&&console.log("Operation cancelled")}))}function continuePay(e){event.preventDefault(),continueCheckout(),$("#primary").modal("hide")}function continueCheckout(){var e=[],t=0;$.each($("#chart").serializeArray(),(function(a,n){"uuid[]"===n.name?e.push({uuid:n.value}):(e[t].qty=n.value,t++)}));let a=$("#paymentMethods").find("button.active");if(0!==e.length){var n={Authorization:"Bearer "+localStorage.getItem("bearer")};$.ajax({url:host+"checkout",type:"POST",data:{data:e,discount:{type:$("#discountDiv").find('input[name="discountType"]').val(),qty:$("#discountDiv").find('input[type="number"][name="discount"]').val()||0},payment_method:a.data("method")},headers:n,success:function(e){selectedMenu=[],$("#chartList").empty(),$("#chart").addClass("align-items-center"),$("#chartList").append('<p class="fs-5 text-center">--Keranjang kosong--</p>'),$("#subTotal").find(".fs-6.fw-bolder").html("Rp0,00"),$("#discount").find(".fs-6.fw-bolder").html("Rp0,00"),$("#totalPayment").find(".fs-5.fw-bolder").html("Rp0,00"),$("#discountDiv").find('input[type="number"]').val(null),$("#continueCheckoutButton").attr("disabled",!0);let t=$("#search");getMenuPrices(t.data("categoryUuid"),t.val()),Toast.fire({icon:"success",title:"Pembelian sukses",timer:1500})},error:function(e,t,a){clearInputErrors();let n=JSON.parse(e.responseText).errors;$.each(n,(function(e,t){let a=e.split(".").find((e=>!isNaN(e))),n=$('input[name="qty[]"]').eq(a),i=n.parent();n.addClass("is-invalid"),i.after('<div class="invalid-feedback d-block">'+t+"</div>")})),Toast.fire({icon:"error",title:"Jumlah pembelian tidak boleh 0",timer:1500})}})}else Toast.fire({icon:"warning",title:"Pilih menu terlebih dahulu",timer:1500})}function setExchangeValue(e){let t=e.value.replace(/\D/g,"");t&&(t=parseFloat(t).toLocaleString("de-DE",{maximumFractionDigits:2})),e.value=t;let a=parseInt($("#checkoutTotal").val()),n=parseInt(t.replace(/\D/g,""))-a,i=parseFloat(n).toLocaleString("de-DE",{maximumFractionDigits:2});n>=0&&($("#customerExchangeMoney").val(i),$("#continueCheckoutButton").attr("disabled",!1)),(n<0||isNaN(t))&&($("#customerExchangeMoney").val(null),$("#continueCheckoutButton").attr("disabled",!0))}function checkout(e){event.preventDefault()}function getMenus(e){loadMenu=!0;var t={uuids:e};if(0==e.length)return $("#chartList").empty(),$("#chart").addClass("align-items-center"),$("#chartList").append('<p class="fs-5 text-center">--Keranjang kosong--</p>'),void(loadMenu=!1);var a={Authorization:"Bearer "+localStorage.getItem("bearer")};$.ajax({url:host+"menu",type:"GET",data:t,headers:a,success:function(e){$.each(e.data,(function(e,t){var a=`<div class="accordion-item" data-uuid="${t.price.uuid}">\n                                <h2 class="accordion-header">\n                                    <button class="btn w-100 collapsed d-flex justify-content-between align-items-center" type="button" data-bs-toggle="collapse" data-bs-target="#panelMenu${t.uuid}" title="${t.name}">\n                                        <p class="fw-bolder m-2 text-start" style="width:140px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${t.name}</p>\n                                        <p class="fs-6 fw-semibold m-2 w-auto">@${t.price_display}</p>\n                                    </button>\n                                </h2>\n                                <div id="panelMenu${t.uuid}" class="accordion-collapse collapse">\n                                    <div class="accordion-body">\n                                        <div class="input-group">\n                                            <span class="input-group-text" data-price-uuid="${t.price.uuid}" onclick="decreaseValue(this)" style="cursor: pointer; user-select: none;">-</span>\n                                            <input type="hidden" name="uuid[]" value="${t.price.uuid}" required>\n                                            <input type="number" name="qty[]" class="form-control text-center" min="0" data-price-uuid="${t.price.uuid}" oninput="debouncedvalidateQty(this)" max="${t.price.stock_remaining}" min="0" value="${t.price.stock_remaining>0?1:0}" required>\n                                            <span class="input-group-text" data-price-uuid="${t.price.uuid}" onclick="increaseValue(this)" style="cursor: pointer; user-select: none;">+</span>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>`;0===$(`#panelMenu${t.uuid}`).length&&($("#chart").removeClass("align-items-center"),$("#chartList").append(a))})),$(".accordion").find(".accordion-item").each((function(){let e=$(this).data("uuid");selectedMenu.includes(e)||$(this).remove()})),refreshStock(selectedCategory),loadMenu=!1},error:function(e,t,a){console.error(JSON.parse(e.responseText).message)}})}function increaseValue(e){var t=$(`input[name="qty[]"][data-price-uuid="${e.dataset.priceUuid}"]`),a=parseInt(t.val()),n=parseInt($(t).attr("max"));a++,parseInt(t.val())!==n&&(parseInt(a)>parseInt(n)&&(a=n),t.val(a),debouncedvalidateQty(t[0]))}function decreaseValue(e){var t=$(`input[name="qty[]"][data-price-uuid="${e.dataset.priceUuid}"]`),a=parseInt(t.val()),n=parseInt($(t).attr("min"));a--,parseInt(t.val())!==n&&(parseInt(a)<parseInt(n)&&(a=n),t.val(a),debouncedvalidateQty(t[0]))}function validateQty(e){parseInt(e.value)>parseInt(e.max)&&(e.value=e.max),parseInt(e.value)<parseInt(e.min)&&(e.value=e.min),refreshStock(selectedCategory),0==parseInt(e.value)&&($(`.accordion-item[data-uuid="${e.dataset.priceUuid}"]`).remove(),Toast.fire({icon:"success",title:"1 menu pada keranjang terhapus",timer:1500}),0==(selectedMenu=selectedMenu.filter((t=>t!==e.dataset.priceUuid))).length&&($("#chart").addClass("align-items-center"),$("#chartList").append('<p class="fs-5 text-center">--Keranjang kosong--</p>')))}function validateDiscount(e){parseInt($(e).val())<parseInt($(e).attr("min"))&&$(e).val(0),$(e).attr("max")&&parseInt($(e).val())>parseInt($(e).attr("max"))&&$(e).val(parseInt($(e).attr("max"))),refreshStock(selectedCategory)}function changeDiscountType(e){$("#dropdownDiscountType").html(`${e.dataset.type}`);let t=$("#discountDiv").find('input[type="number"]'),a=$("#discountDiv").find('input[name="discountType"]');t.val(null),"Nominal"===e.dataset.type&&(t.removeAttr("max"),t.attr("placeholder","Rp"),a.val("nominal")),"Persentase"===e.dataset.type&&(t.attr("max",100),t.attr("placeholder","%"),a.val("persentase"))}function refreshStock(e,t){var a=[],n={category_uuid:e,q:t||$("#search").val()},i=0;$.each($("#chart").serializeArray(),(function(e,t){"uuid[]"===t.name?a.push({uuid:t.value}):(a[i].qty=t.value,i++)}));var s={Authorization:"Bearer "+localStorage.getItem("bearer")};$.ajax({url:host+"menu-price",type:"POST",data:{data:a,discount:{type:$("#discountDiv").find('input[name="discountType"]').val(),qty:$("#discountDiv").find('input[type="number"][name="discount"]').val()||0},query_params:n},headers:s,success:function(e){$("#menuPrices").empty(),$("#subTotal").find(".fs-6.fw-bolder").html(e.meta.subtotal),$("#discount").find(".fs-6.fw-bolder").html(e.meta.discount),$("#totalPayment").find(".fs-5.fw-bolder").html(e.meta.total),$("#checkoutTotal").val(e.meta.total_calc),$("#checkoutTotalPayment").html(`Total Pembayaran: ${e.meta.total}`),selectedMenu.length>0?$("#buttonProceedOrder").prop("disabled",!1):$("#buttonProceedOrder").prop("disabled",!0),$.each(e.data,(function(e,t){var a=`<div class="card bg-secondary m-0 text-white menu-card ${selectedMenu.includes(t.uuid)?"clicked":""}" title="${t.name}" style="cursor: pointer; ${!0!==t.availability?"opacity: 0.5;":""}" data-uuid="${t.uuid}" ${1==t.availability?'onclick="selectMenu(this)"':""}>\n                                <img src="${pageHost}${t.image}" class="card-img-top" style="width: 200px; height: 200px; object-fit: cover;">\n                                <div class="card-body">\n                                    <h5 class="card-title" style="width:140px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${t.name}</h5>\n                                    <p class="card-text">${t.price}</p>\n                                    ${!0!==t.availability?'<p class="card-text">Habis</p>':`<p class="card-text">Stok: ${t.stock_remaining}</p>`}\n                                </div>\n                            </div>`;$("#menuPrices").append(a)})),$.each(e.data,(function(e,t){$(".accordion-item").hasClass("accordion-item")&&$('input[type="number"][name="qty[]"]').each((function(){if($(this).data("priceUuid")===t.uuid){let e=$(this).val(),a=parseInt(e)+parseInt(t.stock_remaining);if($(this).attr({max:a}),0===parseInt(a)){let e=$(this).closest(".accordion-item"),t=e.data("uuid");selectedMenu=selectedMenu.filter((e=>e!==t)),e.remove(),$(`.menu-card[data-uuid="${t}"]`).toggleClass("clicked")}}}))}))},error:function(e,t,a){console.error(JSON.parse(e.responseText).message)}})}function getMenuCategory(e){var t={Authorization:"Bearer "+localStorage.getItem("bearer")};$.ajax({url:host+"menu-category",type:"GET",data:{hasMenu:!0},headers:t,success:function(e){$("#kategoriMenu").empty();$("#kategoriMenu").append('<div class="card bg-secondary menu-category-card-selected clicked m-0 text-white menu-category-card" style="cursor: pointer; flex-shrink: 0; min-width: 150px;" onclick="selectCategory(this)">\n                                <div class="card-body">\n                                    <p class="card-text">Semua</p>\n                                </div>\n                            </div>'),$.each(e.data,(function(e,t){var a=`<div class="card bg-secondary m-0 text-white menu-category-card" style="cursor: pointer; flex-shrink: 0; min-width: 150px;" data-uuid="${t.uuid}" onclick="selectCategory(this)">\n                                <div class="card-body">\n                                    <p class="card-text">${t.name}</p>\n                                </div>\n                            </div>`;$("#kategoriMenu").append(a)}))},error:function(e,t,a){console.error(JSON.parse(e.responseText).message)}})}const debouncedGetMenu=debounce(getMenus,350),debouncedValidateDiscount=debounce(validateDiscount,500),debouncedSearch=debounce(searchMenu,500),debouncedvalidateQty=debounce(validateQty,500);function searchMenu(e){$(".accordion-item").hasClass("accordion-item")?refreshStock(e.dataset.categoryUuid):getMenuPrices(e.dataset.categoryUuid,e.value)}function debounce(e,t){let a;return function(){const n=this,i=arguments;clearTimeout(a),a=setTimeout((()=>e.apply(n,i)),t)}}function getMenuPrices(e,t){var a={category_uuid:e,q:t||$("#search").val()},n={Authorization:"Bearer "+localStorage.getItem("bearer")};$.ajax({url:host+"menu-price",type:"GET",data:a,headers:n,success:function(e){$("#menuPrices").empty(),$.each(e.data,(function(e,t){var a=`<div class="card bg-secondary m-0 text-white menu-card ${selectedMenu.includes(t.uuid)?"clicked":""}" title="${t.name}" style="cursor: pointer; ${!0!==t.availability?"opacity: 0.5;":""}" data-uuid="${t.uuid}" ${1==t.availability?'onclick="selectMenu(this)"':""}>\n                                <img src="${pageHost}${t.image}" class="card-img-top" style="width: 200px; height: 200px; object-fit: cover;">\n                                <div class="card-body">\n                                    <h5 class="card-title" style="width:140px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${t.name}</h5>\n                                    <p class="card-text">${t.price}</p>\n                                    ${!0!==t.availability?'<p class="card-text">Habis</p>':`<p class="card-text">Stok: ${t.stock_remaining}</p>`}\n                                </div>\n                            </div>`;$("#menuPrices").append(a)}))},error:function(e,t,a){console.error(JSON.parse(e.responseText).message)}})}function changeActivePaymentMethod(e){document.querySelectorAll("#paymentMethods .btn").forEach((e=>e.classList.remove("active"))),e.classList.add("active")}function scrollCategoryMenu(){const e=$("#kategoriMenu");let t,a,n=!1;e.on("mousedown",(function(i){n=!0,e.addClass("active"),t=i.pageX-e.offset().left,a=e.scrollLeft()})),e.on("mouseleave",(function(){n=!1,e.removeClass("active")})),e.on("mouseup",(function(){n=!1,e.removeClass("active")})),e.on("mousemove",(function(i){if(!n)return;i.preventDefault();const s=1*(i.pageX-e.offset().left-t);e.scrollLeft(a-s)}))}
